<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Courier+Prime|Montserrat&display=swap"/><link rel="stylesheet" href="./css/blog.css"/></head><body><div id="layout" class="pure-g"><div><div class="pure-menu pure-menu-horizontal pure-u-1-1 top-header"><a class="pure-menu-heading" href="/">thorstenstark</a><ul class="pure-menu-list"><li class="pure-menu-item"><a class="pure-menu-link" href="/about">About</a></li></ul></div></div><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><div id="layout" class="pure-g"><div class="author__avatar"><img src="https://s.gravatar.com/avatar/30604534421fa73dac944bee03a02aec?s=80"/></div><div class="pure-u-md-1-1 pure-u-3-4"><h1 class="brand-title">Thorsten Stark</h1><h3 class="brand-tagline">An iOS Developers Blog</h3></div></div><div id="layout" class="pure-g"><div class="pure-u-md-1-1"><a href="mailto:mail@thorsten-stark.de"><i class="far fa-envelope-open l-box social-icon"></i><a class="social-media" href="mailto:mail@thorsten-stark.de">Email</a></a></div><div class="pure-u-md-1-1"><a href="https://www.linkedin.com/in/thorsten-stark-857a4436/"><i class="fab fa-linkedin l-box social-icon"></i><a class="social-media" href="https://www.linkedin.com/in/thorsten-stark-857a4436/">LinkedIn</a></a></div><div class="pure-u-md-1-1"><a href="https://github.com/thorstenstark"><i class="fab fa-github l-box social-icon"></i><a class="social-media" href="https://github.com/thorstenstark">thorstenstark</a></a></div><div class="pure-u-md-1-1"><a href="https://twitter.com/Tho_Stark"><i class="fab fa-twitter l-box social-icon"></i><a class="social-media" href="https://twitter.com/Tho_Stark">@Tho_Stark</a></a></div></div></div></div><div class="content pure-u-1 pure-u-md-3-5 pure-u-xl-6-10"><h2 class="post-title"><a href="/posts/Migrating-large-git-repository">Migrating a large git repository to GitHub</a></h2><p class="post-meta">3. Februar 2020</p><div class="post-tags"><a class="post-category post-category-git" href="/tags/git">Git</a><a class="post-category post-category-github" href="/tags/github">GitHub</a><a class="post-category post-category-git lfs" href="/tags/git-lfs">Git LFS</a><a class="post-category post-category-shell" href="/tags/shell">Shell</a></div><div class="post-description"><div><h1>Migrating a large git repository to GitHub</h1><p>We recently wanted to move our repository to GitHub. In theory that should be as simple as clicking the â€žImport Repositoryâ€œ button. So we clicked that button and entered the necessary information for the migration tool. After only 5h hours of migration, the process failed with an â€žError uploading commitsâ€œ. No further information.</p><p>Using the command line to migrate the repository manually showed at least one reason why the upload failed. Our repository contained some files larger than 100 MB. Github has a hard limit when it comes to file sizes. Only files smaller than 100 MB are allowed to be stored in the git repository. Larger files must be stored in git LFS (Large File Storage). Usually, the GitHub migration tool should recognize those files and offer to move them to LFS or remove them from the repository. For unknown reasons, this didn't work for us. If this works for you: lucky you. After a few days struggling with the repository migration and some email exchange with the GitHub support, we figured out a way how to migrate our large repository to Github.</p><p>The short version: <em> Clone your entire repository to your computer </em> Move all large files to LFS <em> Create a local working copy from the modified repository </em> Upload every branch you need to the new remote (Github)</p><p><strong>Prerequisite:</strong> As Git LFS isnâ€˜t part of git itself you have to install it manually on your machine from the <a href="https://git-lfs.github.com">Git LFS</a> page.</p><p>For everyone who doesn't know the concrete steps to do this (like me before) here comes the more detailed version:</p><h2>Step 1 â€“ Clone the complete repository</h2><pre><code>git clone --bare git@hoster.<span class="property">com</span>:username/repository.<span class="property">git</span>
</code></pre><p>This is nearly the same you do with every git repository you clone, but here the parameter <code>--bare</code> is an important difference. A normal <code>git clone</code> will create a so-called working copy of the repository on your computer and checks out the main branch i.e. <code>master</code> or <code>develop</code>. Adding <code>--bare</code> results in a full copy of the repository on your computer. Usually, it also has the extension <code>.git</code> This is the same format as on the remote host. But you can't work in this repository as you can only work in working copies (as the name suggests). <strong>Attention:</strong> After cloning the repository it would be wise to make a backup of this repository in case anything goes wrong especially because we are going to rewrite a great bunch of your git history in a few moments. An easy way to backup is to simply archive the folder called <code>&lt;your-repository-name&gt;.git</code> you just cloned.</p><h2>Step 2 â€“ Move big files to Git LFS</h2><p>Download BFG Repo Cleaner from its website <a href="https://rtyley.github.io/bfg-repo-cleaner/ "here"">here</a>. Next to other features, the one feature we are interested in is its capability to convert files to be stored in Git LFS. And this includes all files in the entire history of your git repository. But be careful, as mentioned earlier this rewrites the history of your repository, making it incompatible with the original version. In this example we want all file with the extensions <code>jpg</code> or <code>mov</code> to be moved to LFS:</p><pre><code>java -jar path/to/bfg-x.<span class="property">y</span>.<span class="property">z</span>.<span class="property">jar</span> --convert-to-git-lfs <span class="string">"{*.jpg,*.mov}"</span> --no-blob-protection path/to/local/repository.<span class="property">git</span>
</code></pre><p>After BFG has done its job we need to clean up a bit. The following command executes some kind of garbage collector to clean up the reflog and remove unused files from the repository.</p><pre><code>cd path/to/local/repository.<span class="property">git</span>
git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive
</code></pre><p>Next thing to do is to set up Git LFS and the required hooks by calling:</p><pre><code>git lfs install
</code></pre><h2>Step 3 â€“ Upload modified repository</h2><p>The best way now would be to just copy the whole modified repo to its new host. The required command would be this one here:</p><pre><code>git push --mirror git@github.<span class="property">com</span>:username/new-repository.<span class="property">git</span>
</code></pre><p>Unfortunately, this didnâ€˜t work for us so we had to come up with another solution.</p><p>Remember that the repository.git folder is the exact same format as your repository stored on a remote host. This means we can create a working copy from this file:</p><pre><code>git clone path/to/local/repository.<span class="property">git</span>
</code></pre><p>Now we have a checked-out version of our repository and can work on it like in any other cloned repository. We can change files, make commits or change/add the remote. Let's add a new remote pointing to our desired new repository. In this example, we name this new remote just <code>newOrigin</code> as the old remote is still there and is called <code>origin</code> by default. But you can choose any name you like. Just keep the old origin. We will soon see why...</p><pre><code>git remote add newOrigin git@github.<span class="property">com</span>:username/new-repository.<span class="property">git</span>
</code></pre><p>The last step needs some more manual work. We will check out all relevant branches from <code>origin</code> and push/publish them to <code>newOrigin</code> â€“ one by one.</p><p>Congratulations! ðŸŽ‰ You just transferred your too large repository to GitHub!</p><p><strong>Notice:</strong> it may be that some branches were not correctly modified by BFG. This may be caused by special characters in your branch names. You should not upload these branches to <code>newOrigin</code> because the content of this branch is not compatible with the other modified branches anymore. You recognize these branches when they take notably longer to upload than the other branches. Therefore, it helps when the first branch you upload is the master branch. So all other branches rely on commits already pushed with master, except for those branches not modified by BFG.</p></div></div></div><div class="footer pure-u-1"><div class="pure-u-1">Â© 2020 Thorsten Stark</div><div class="pure-u-1">Generated using <a href="https://github.com/johnsundell/publish">Publish</a>. Written in Swift</div><div class="pure-u-1"><a href="/feed.rss">RSS feed</a></div></div></div></body></html>